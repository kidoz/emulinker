# Maintainer: Your Name <your.email@example.com>
pkgname=kaillux
pkgver=1.1.0
pkgrel=1
pkgdesc="Kaillera network server for emulator-based online multiplayer gaming"
arch=('any')
url="https://github.com/kidoz/kaillux"
license=('GPL-2.0-only')
depends=('java-runtime>=25')
makedepends=('java-environment>=25' 'git')
backup=('etc/kaillux/application.properties'
        'etc/kaillux/access.cfg'
        'etc/kaillux/logback.xml')
install=kaillux.install
source=("${pkgname}-${pkgver}.tar.gz::${url}/archive/v${pkgver}.tar.gz"
        'kaillux.service'
        'kaillux.sysusers'
        'kaillux.tmpfiles')
sha256sums=('SKIP'
            'SKIP'
            'SKIP'
            'SKIP')

# For local development, use this instead:
# source=("git+file:///path/to/local/kaillux")

build() {
    cd "${srcdir}/${pkgname}-${pkgver}"

    # Build with Gradle (skip tests for packaging)
    ./gradlew clean build -x test -x spotbugsMain -x spotbugsTest -x checkstyleMain -x checkstyleTest
}

package() {
    cd "${srcdir}/${pkgname}-${pkgver}"

    # Install JAR file
    install -Dm644 "build/kaillux.jar" "${pkgdir}/usr/share/java/${pkgname}/${pkgname}.jar"

    # Install configuration files
    install -Dm644 "src/main/resources/application.properties" "${pkgdir}/etc/${pkgname}/application.properties"
    install -Dm644 "src/main/resources/access.cfg" "${pkgdir}/etc/${pkgname}/access.cfg"
    install -Dm644 "src/main/resources/logback.xml" "${pkgdir}/etc/${pkgname}/logback.xml"

    # Install wrapper script
    install -Dm755 /dev/stdin "${pkgdir}/usr/bin/${pkgname}" << 'EOF'
#!/bin/bash
# Kaillux Kaillera Server launcher

KAILLUX_JAR="/usr/share/java/kaillux/kaillux.jar"
KAILLUX_CONF="/etc/kaillux"
# Java 25: Enable Compact Object Headers for reduced memory footprint
KAILLUX_OPTS="${KAILLUX_OPTS:--Xms64m -Xmx256m -XX:+UseCompactObjectHeaders}"

exec /usr/bin/java \
    ${KAILLUX_OPTS} \
    -jar "${KAILLUX_JAR}" \
    --spring.config.location="file:${KAILLUX_CONF}/" \
    "$@"
EOF

    # Install systemd service
    install -Dm644 "${srcdir}/kaillux.service" "${pkgdir}/usr/lib/systemd/system/${pkgname}.service"

    # Install sysusers.d configuration (creates kaillux user)
    install -Dm644 "${srcdir}/kaillux.sysusers" "${pkgdir}/usr/lib/sysusers.d/${pkgname}.conf"

    # Install tmpfiles.d configuration (creates /var/lib/kaillux)
    install -Dm644 "${srcdir}/kaillux.tmpfiles" "${pkgdir}/usr/lib/tmpfiles.d/${pkgname}.conf"

    # Install documentation
    install -Dm644 "README.md" "${pkgdir}/usr/share/doc/${pkgname}/README.md"
    install -Dm644 "LICENSE" "${pkgdir}/usr/share/licenses/${pkgname}/LICENSE"
}
